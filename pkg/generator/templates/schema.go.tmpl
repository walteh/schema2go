// Code generated by schema2go. DO NOT EDIT.
// üèóÔ∏è Generated from JSON Schema

package {{ .Package }}

import (
	"encoding/json"
	"gitlab.com/tozd/go/errors"
)

{{- range .Structs }}

{{ if .Description -}}
// {{ .Description }}
{{- end }}
type {{ .Name }} struct {
	{{- range .Fields }}
	{{ if .Description -}}
	// {{ .Description }}
	{{- end }}
	{{- .Name }} {{ .Type }} `json:"{{ .JSONName }}{{ if not .IsRequired }},omitempty{{ end }}"` {{- if .IsRequired }} // Required{{- end }}{{- if .DefaultValue }} // Default: {{ .DefaultValue }}{{- end }}
	{{- end }}
}

{{- if .HasDefaults }}

// UnmarshalJSON implements json.Unmarshaler
func (x *{{ .Name }}) UnmarshalJSON(data []byte) error {
	// Define an alias to prevent recursive UnmarshalJSON calls
	type Alias {{ .Name }}
	aux := &struct {
		*Alias
	}{
		Alias: (*Alias)(x),
	}
	if err := json.Unmarshal(data, &aux); err != nil {
		return errors.Errorf("unmarshaling json: %w", err)
	}

	// Apply defaults for missing fields
	{{- range .Fields }}
	{{- if .DefaultValue }}
	if x.{{ .Name }} == nil {
		defaultValue := {{ .DefaultValue }}
		x.{{ .Name }} = &defaultValue
	}
	{{- end }}
	{{- end }}

	// Validate after applying defaults
	if err := x.Validate(); err != nil {
		return errors.Errorf("validating after unmarshal: %w", err)
	}

	return nil
}
{{- end }}

{{- if .HasValidation }}

// Validate ensures all required fields are present and valid
func (x *{{ .Name }}) Validate() error {
	{{- range .Fields }}
	{{- $fieldName := .Name }}
	{{- range .ValidationRules }}
	{{- if eq .Type "required" }}
	if x.{{ $fieldName }} == "" {
		return errors.New("{{ .Message }}")
	}
	{{- end }}
	{{- if eq .Type "min" }}
	if x.{{ $fieldName }} < {{ .Value }} {
		return errors.New("{{ .Message }}")
	}
	{{- end }}
	{{- if eq .Type "max" }}
	if x.{{ $fieldName }} > {{ .Value }} {
		return errors.New("{{ .Message }}")
	}
	{{- end }}
	{{- if eq .Type "pattern" }}
	if !regexp.MustCompile({{ .Value }}).MatchString(x.{{ $fieldName }}) {
		return errors.New("{{ .Message }}")
	}
	{{- end }}
	{{- if eq .Type "minLength" }}
	if len(x.{{ $fieldName }}) < {{ .Value }} {
		return errors.New("{{ .Message }}")
	}
	{{- end }}
	{{- if eq .Type "maxLength" }}
	if len(x.{{ $fieldName }}) > {{ .Value }} {
		return errors.New("{{ .Message }}")
	}
	{{- end }}
	{{- end }}
	{{- end }}
	return nil
}

// MarshalJSON implements json.Marshaler
func (x {{ .Name }}) MarshalJSON() ([]byte, error) {
	// Validate before marshaling
	if err := x.Validate(); err != nil {
		return nil, errors.Errorf("validating before marshal: %w", err)
	}

	// Use alias to avoid infinite recursion
	type Alias {{ .Name }}
	return json.Marshal((*Alias)(&x))
}
{{- end }}

{{- if .HasCustomMarshaling }}

// MarshalJSON implements json.Marshaler
func (x {{ .Name }}) MarshalJSON() ([]byte, error) {
	// TODO: Implement custom marshaling
	return nil, nil
}

// UnmarshalJSON implements json.Unmarshaler
func (x *{{ .Name }}) UnmarshalJSON(data []byte) error {
	// TODO: Implement custom unmarshaling
	return nil
}
{{- end }}

{{- end }} 