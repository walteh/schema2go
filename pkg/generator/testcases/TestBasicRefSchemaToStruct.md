# input

```json
{
	"$schema": "http://json-schema.org/draft-07/schema#",
	"title": "RefExample",
	"type": "object",
	"properties": {
		"person": {
			"$ref": "#/definitions/Person"
		},
		"innerPerson": {
			"type": "object",
			"properties": {
				"name": {
					"type": "string"
				},
				"age": {
					"type": "integer"
				}
			}
		}
	},
	"definitions": {
		"Person": {
			"type": "object",
			"properties": {
				"name": {
					"type": "string"
				},
				"age": {
					"type": "integer"
				}
			}
		}
	}
}
```

---

# expected-output

```go
// Code generated by schema2go. DO NOT EDIT.
// üèóÔ∏è Generated from JSON Schema

package models

import (
    "encoding/json"
    "gitlab.com/tozd/go/errors"
)

type Person struct {
	Name *string `json:"name,omitempty"`
	Age  *int    `json:"age,omitempty"`
}

// UnmarshalJSON implements json.Unmarshaler
func (x *Person) UnmarshalJSON(data []byte) error {
    // Create an alias to avoid infinite recursion
    type Alias Person
    aux := &struct {
        *Alias
    }{
        Alias: (*Alias)(x),
    }

    // First unmarshal into our alias struct
    if err := json.Unmarshal(data, &aux); err != nil {
        return errors.Errorf("unmarshaling json: %w", err)
    }

    // Validate after unmarshaling
    if err := x.Validate(); err != nil {
        return errors.Errorf("validating after unmarshal: %w", err)
    }

    return nil
}

// Validate ensures all required fields are present and valid
func (x *Person) Validate() error {
    return nil
}

// MarshalJSON implements json.Marshaler
func (x Person) MarshalJSON() ([]byte, error) {
    // Validate before marshaling
    if err := x.Validate(); err != nil {
        return nil, errors.Errorf("validating before marshal: %w", err)
    }

    // Use alias to avoid infinite recursion
    type Alias Person
    return json.Marshal((*Alias)(&x))
}

type RefExample struct {
	Person      *Person                `json:"person,omitempty"`
    InnerPerson *RefExampleInnerPerson `json:"innerPerson,omitempty"`
}

// UnmarshalJSON implements json.Unmarshaler
func (x *RefExample) UnmarshalJSON(data []byte) error {
    // Create an alias to avoid infinite recursion
    type Alias RefExample
    aux := &struct {
        *Alias
    }{
        Alias: (*Alias)(x),
    }

    // First unmarshal into our alias struct
    if err := json.Unmarshal(data, &aux); err != nil {
        return errors.Errorf("unmarshaling json: %w", err)
    }

    // Validate after unmarshaling
    if err := x.Validate(); err != nil {
        return errors.Errorf("validating after unmarshal: %w", err)
    }

    return nil
}

// Validate ensures all required fields are present and valid
func (x *RefExample) Validate() error {
    if x.Person != nil {
        if err := x.Person.Validate(); err != nil {
            return errors.Errorf("validating person: %w", err)
        }
    }
    if x.InnerPerson != nil {
        if err := x.InnerPerson.Validate(); err != nil {
            return errors.Errorf("validating innerPerson: %w", err)
        }
    }
    return nil
}

// MarshalJSON implements json.Marshaler
func (x RefExample) MarshalJSON() ([]byte, error) {
    // Validate before marshaling
    if err := x.Validate(); err != nil {
        return nil, errors.Errorf("validating before marshal: %w", err)
    }

    // Use alias to avoid infinite recursion
    type Alias RefExample
    return json.Marshal((*Alias)(&x))
}

type RefExampleInnerPerson struct {
    Name *string `json:"name,omitempty"`
    Age  *int    `json:"age,omitempty"`
}

// UnmarshalJSON implements json.Unmarshaler
func (x *RefExampleInnerPerson) UnmarshalJSON(data []byte) error {
    // Create an alias to avoid infinite recursion
    type Alias RefExampleInnerPerson
    aux := &struct {
        *Alias
    }{
        Alias: (*Alias)(x),
    }

    // First unmarshal into our alias struct
    if err := json.Unmarshal(data, &aux); err != nil {
        return errors.Errorf("unmarshaling json: %w", err)
    }

    // Validate after unmarshaling
    if err := x.Validate(); err != nil {
        return errors.Errorf("validating after unmarshal: %w", err)
    }

    return nil
}

// Validate ensures all required fields are present and valid
func (x *RefExampleInnerPerson) Validate() error {
    return nil
}

// MarshalJSON implements json.Marshaler
func (x RefExampleInnerPerson) MarshalJSON() ([]byte, error) {
    // Validate before marshaling
    if err := x.Validate(); err != nil {
        return nil, errors.Errorf("validating before marshal: %w", err)
    }

    // Use alias to avoid infinite recursion
    type Alias RefExampleInnerPerson
    return json.Marshal((*Alias)(&x))
}
```
